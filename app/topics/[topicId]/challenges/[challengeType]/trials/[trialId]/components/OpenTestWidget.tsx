'use client'

import { useState, useEffect, useRef, forwardRef } from "react";
import { MaskedSvgIcon } from "@/app/components/MaskedSvgIcon";
import { SpeechButton, SpeechButtonHandle } from "./SpeechButton";
import { AudioDevicePopup } from "@/app/components/AudioDevicePopup";
import { useVoiceRecording } from "@/app/hooks/useVoiceRecording";
import { useCarMode } from "@/context/CarModeContext";
import { useAudio } from "@/context/AudioContext";
import RoundButton from "@/app/ui/buttons/RoundButton";

interface OpenTestWidgetProps {
    question: string;
    onAnswer: (answer: string) => void;
}

export const OpenTestWidget = forwardRef<SpeechButtonHandle, OpenTestWidgetProps>(function OpenTestWidget({ question, onAnswer }, ref) {

    const [answer, setAnswer] = useState("");
    const textareaRef = useRef<HTMLTextAreaElement>(null);
    const speechButtonRef = useRef<SpeechButtonHandle>(null);
    const [selectedDeviceId, setSelectedDeviceId] = useState<string>("");
    const { audioDevices, loadAudioDevices } = useVoiceRecording();
    const { carMode } = useCarMode();
    const { replay } = useAudio();

    const handleSubmit = (answerToSubmit?: string) => {
        onAnswer(answerToSubmit || answer.trim());
        setAnswer("");
    };

    /**
     * When voice recording is complete and transcribed, set as answer. 
     * 
     * When in car mode, send (post) directly the answer
     */
    const handleVoiceRecording = async (transcribedText: string) => {
        console.log("Transcribed text:", transcribedText);

        // Set the transcribed text as the answer
        setAnswer(transcribedText);

        // When car mode is enabled, don't wait for the user to press the submit button and do it automatically
        if (carMode) handleSubmit(transcribedText);
    };

    // Auto-expand textarea
    useEffect(() => {
        if (textareaRef.current) {
            textareaRef.current.style.height = 'auto';
            textareaRef.current.style.height = Math.min(textareaRef.current.scrollHeight, 200) + 'px';
        }
    }, [answer]);

    // Forward the speech button ref to parent
    useEffect(() => {
        if (ref) {
            // Forward the speech button methods to the parent ref
            if (typeof ref === 'function') {
                ref(speechButtonRef.current);
            } else {
                ref.current = speechButtonRef.current;
            }
        }
    }, [ref]);

    return (
        <div className="flex flex-1 flex-col w-full max-w-2xl mx-auto mt-8">
            {/* Question */}
            <div className="mb-8 text-xl">{question}</div>
            <div className="flex-1" />

            {/* When not in car mode, show the input box */}
            {!carMode && (
                <div className="pb-8">
                    <div className="flex items-center justify-end mb-2">
                        <AudioDevicePopup
                            audioDevices={audioDevices}
                            loadAudioDevices={loadAudioDevices}
                            onDeviceSelected={setSelectedDeviceId}
                        />
                        <div className="flex-1" />
                        <SpeechButton
                            ref={speechButtonRef}
                            onRecordingComplete={handleVoiceRecording}
                            deviceId={selectedDeviceId}
                            mode="whisper"
                        />
                    </div>
                    <div className="relative">
                        <textarea
                            ref={textareaRef}
                            value={answer}
                            onChange={(e) => setAnswer(e.target.value)}
                            placeholder="Type your answer..."
                            rows={1}
                            className="w-full py-4 px-2 pr-28 bg-transparent border-2 border-cyan-300 rounded-lg focus:outline-none text-lg resize-none overflow-y-auto no-scrollbar placeholder:text-cyan-200"
                            style={{ maxHeight: '200px', fontSize: '16px', touchAction: 'manipulation' }}
                        />
                        {/* Submit button */}
                        <button
                            onClick={() => { handleSubmit(); }}
                            disabled={!answer.trim()}
                            className="absolute right-3 bottom-5 flex items-center justify-center transition"
                        >
                            <MaskedSvgIcon
                                src="/images/send.svg"
                                alt="Send"
                                size="w-6 h-6"
                                color={answer.trim() ? "bg-lime-200" : "bg-cyan-400"}
                            />
                        </button>
                    </div>
                </div>
            )}

            {/* When in car mode, show only the speech button, but HUGE */}
            {carMode && (
                <div className="flex items-center justify-center gap-4 mb-8">
                    <div className="flex flex-1 justify-start">
                        <AudioDevicePopup
                            audioDevices={audioDevices}
                            loadAudioDevices={loadAudioDevices}
                            onDeviceSelected={setSelectedDeviceId}
                        />
                    </div>
                    <div className="flex justify-center">
                        <SpeechButton
                            size="car"
                            ref={speechButtonRef}
                            onRecordingComplete={handleVoiceRecording}
                            deviceId={selectedDeviceId}
                        />
                    </div>
                    <div className="flex-1 flex justify-end">
                        <RoundButton
                            svgIconPath={{ src: "/images/voice.svg", alt: "Replay question" }}
                            onClick={() => { replay(); }}
                        />
                    </div>
                </div>
            )}

        </div>
    );
});

